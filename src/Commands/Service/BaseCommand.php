<?php

namespace Mix\Http\Daemon\Commands\Service;

use Mix\Ini\IniParser;
use Mix\Console\CommandLine\Flag;
use Mix\Console\PidFileHandler;
use Mix\Helpers\FileSystemHelper;
use Mix\Core\Bean\AbstractObject;

/**
 * Class BaseCommand
 * @package Httpd\Commands\Service
 */
class BaseCommand extends AbstractObject
{

    /**
     * 提示
     */
    const IS_RUNNING = 'Service is running, PID : %d';
    const NOT_RUNNING = 'Service is not running.';
    const EXEC_SUCCESS = 'Command executed successfully.';

    /**
     * 配置信息
     * @var array
     */
    public $config;

    /**
     * 初始化事件
     */
    public function onInitialize()
    {
        parent::onInitialize(); // TODO: Change the autogenerated stub
        // 服务器配置处理
        $filename = Flag::string(['c', 'configuration'], '');
        if ($filename == '') {
            throw new \Mix\Exceptions\InvalidArgumentException('Option \'-c/--configuration\' required.');
        }
        if (!FileSystemHelper::isAbsolute($filename)) {
            $filename = getcwd() . DIRECTORY_SEPARATOR . $filename;
        }
        $ini = new IniParser([
            'filename' => $filename,
        ]);
        if (!$ini->load()) {
            throw new \Mix\Exceptions\InvalidArgumentException("Configuration file not found: {$filename}");
        }
        // 应用配置处理
        $configFile = $ini->section('application.config_file');
        if (!FileSystemHelper::isAbsolute($configFile)) {
            $iniDir     = \Mix\Helpers\FileSystemHelper::dirname($filename);
            $configFile = $iniDir . DIRECTORY_SEPARATOR . $configFile;
        }
        if (!is_file($configFile)) {
            $iniFile = \Mix\Helpers\FileSystemHelper::basename($filename);
            throw new \Mix\Exceptions\InvalidArgumentException("{$iniFile}: 'application.config_file' file not found: {$configFile}");
        }
        // 构造配置信息
        $this->config = [
            'host'       => $ini->section('server.host'),
            'port'       => $ini->section('server.port'),
            'configFile' => $configFile,
            'setting'    => $ini->section('setting'),
        ];
        // 配置日志组件
        $handler         = app()->log->handler;
        $handler->single = $this->config['settings']['log_file'] ?? '';
        // Swoole 判断
        if (!extension_loaded('swoole')) {
            throw new \RuntimeException('Need swoole extension to run, install: https://www.swoole.com/');
        }
    }

    /**
     * 获取pid
     * @return bool|string
     */
    public function getServicePid()
    {
        $handler = new PidFileHandler(['pidFile' => $this->config['settings']['pid_file'] ?? '']);
        return $handler->read();
    }

}
